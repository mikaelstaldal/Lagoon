<?xml version="1.0" encoding="iso-8859-1"?>
<html>
<head>
<title>Lagoon User Guide</title>
<link rel="stylesheet" type="text/css" href="manual.css" />
</head>
<body>
<h1>Lagoon User Guide</h1>

<h2>Overview</h2>

<p>Lagoon is an XML-based framework for web site maintenance.</p>

<p>Lagoon does not require support for any dynamic content technology,
such as Servlets, CGI, ASP, SSI, PHP or JSP, on the web server. It's
therefore very useful for sites on cheep web hotels which gives limited
(or no) access to dynamic content features. However, Lagoon is
useful larger sites too, and can be used together with other
dynamic content technologies.</p>

<p>Lagoon is also useful for building HTML based documentation bundles,
for viewing without a web server.</p>

<h2>Background and philosophy</h2>

<h3>The web server: Static and dynamic content</h3>

<p>The basic functionality of a web server is to send the content of a
regular file stored on disk as the response of a request, this is
called static content. The other alternative is to start a process
that generates the response for each request, this is called dynamic
content. The use of dynamic content can be divided into several
categories as follows.</p>

<dl>
<dt>Pseudo-dynamic</dt><dd>where the requested document is generated by
composing information from several files and/or from a database. The
information in the files and in the database is static, i.e. updated in
a controlled manner and not very frequently. This is called
<em>pseudo-dynamic</em> since the produced document is a function of static
information only. In principle, this use of dynamic content is not
necessary since the updates could have been done in static content. The
main reason for using this approach is easier maintenance and updates.
Technologies such as SSI, ASP, PHP and JSP are used for this.</dd>

<dt>Real-time data</dt><dd>where the generated document depends on some
information that is updated frequently and outside the control of the
web server. Technologies such as CGI and Servlets (sometimes also ASP,
PHP and JSP) are used for this.</dd>

<dt>User interaction</dt><dd>where the generated document depends on
parameters in the request and/or state information from previous
requests. Technologies such as CGI and Servlets (sometimes also ASP,
PHP and JSP) are used for this.</dd>
</dl>

<p>It is also possible to have combinations (such as both real-time data
and user interaction).</p>


<h3>Where Lagoon fits in</h3>

<p>Lagoon produces all your pseudo-dynamic content off-line, and send
the result to the web server as static files. This can give better
performance, since processing doesn't have to be done at each request.
This also gives you convenient pseudo-dynamic content on a web server
without explicit support for it.</p>

<p>Lagoon does <em>not</em> handle user interaction, you have to use
the conventional technologies for this. However, while using ASP, JSP
(or whatever) for the few pages with user interaction, you can still
use Lagoon for the rest of the site.</p>

<p>Lagoon can in some cases be used for real-time data, but this
requires a more complicated setup than usual. See the <a
href="advuserguide.html">Advanced User Guide</a>.</p>

<p>In addition, Lagoon keeps track of all content for your web site,
including static files (HTML, images, etc.) and any files for user
interaction (ASP or JSP pages, CGI scripts, or whatever). Lagoon
automatically detects if any source file is updated and regenerate the
dependent content as necessary (and only when necessary). Lagoon can be
seen as a Make tool for web sites, you have the "source code" on your
computer, Lagoon performs "compilation" as necessary and stores the
"object code" directly on the web server (with FTP or SSH if the web
server is remote). This is especially useful if you have a large web
site and updates it over a slow dial-up modem connection; if you make
changes to only a few pages, only those pages are actually transmitted
to the web server.</p>


<h2>User requirements</h2>

<p>To make use of Lagoon, you need to know XML (including namespaces).
Many usage patterns require knowledge of XSLT too. See <a
href="http://www.w3.org/xml/">http://www.w3.org/xml/</a> for more information
of XML, XSLT and related technologies.</p>

<p>You don't need to know the Java programming language to make use of
the basic features of Lagoon.</p>


<h2>System requirements</h2>

<ul>
<li>A Java2 Runtime Environment (JRE), version 1.4 or later. See <a href="http://java.sun.com/">http://java.sun.com/</a> 
for information on how to obtain a JRE. Note that the Java Development Kit (J2SDK) 
includes a JRE, you don't need to separately install a JRE if you already
have a J2SDK.</li>

<li>To use XSL:FO to PDF formatting, you need Apache FOP 
version 0.20.3. You can download it from 
<a href="http://xml.apache.org/dist/">http://xml.apache.org/dist/</a>.
</li>

<li>To use SVG rendering, you need Apache Batik version 1.1.1. 
You can download it from 
<a href="http://xml.apache.org/dist/">http://xml.apache.org/dist/</a>. 
</li>

<li>To use SSH, you need a command-line based SSH client. Most (but
not all) SSH clients for Windows are GUI based, and will not work. A
SSH client will probably work with Lagoon if and only if it works with
CVS. The OpenSSH port in Cygwin works.</li>
</ul>


<h2>Installation</h2>

<ol> 
<li>Make sure that your JRE is properly installed and working.</li>
<li>If you plan to use Batik and/or FOP, add the distribution JAR files 
Batik and/or FOP to your Java <code>CLASSPATH</code>, or install them as 
standard extensions in your JRE.</li> 
<li>Add the <code>bin</code> directory (which contains scripts for Windows, 
OS/2 and UNIX based systems) to your <code>PATH</code> and set an
environment variable <code>LAGOON_HOME</code> to the directory where you
installed Lagoon. Alternativly, you can add the <code>.jar</code> files in 
the Lagoon distribution to your Java <code>CLASSPATH</code>).</li> 
</ol>


<h2>The sitemap</h2>

<p>Lagoon is based on a <em>sitemap</em>, which is a file describing
the structure of the website. The sitemap is in XML format, see
the <a href="sitemap.rng">schema</a> A sitemap may have a name which 
unique identifies it on the system.</p>

<p>The sitemap has entries for files, each <code>&lt;file&gt;</code>
entry describes how that file should be created. 
The target is the request URL for the web server, 
and must be specified as a pseudo-absolute URL. The source URL must be 
specified as an absolute or pseudo-absolute URL. If source is omitted, 
it's set to the same string as target (including any wildcard). 
The pipeline must end with a byte producer. As a shortcut, an empty 
<code>file</code> element is equvivalent to a <code>file</code> element 
with a single <code>read</code> 
child.</p>

<p>The sitemap may also contain <code>&lt;part&gt;</code>
entries, which defines a partial document, to be included by another document. 
A <code>part</code> has a name, which is not an URL. The source URL must be 
specified as an absolute or pseudo-absolute URL. The pipeline must end with an 
XML producer. Wildcards may not be used.</p>

<p>The sitemap may also contain <code>&lt;output&gt;</code> entries, which
defines the end of the pipeline for use by several targets (and escially by 
the island feature). An <code>&lt;output&gt;</code> entry has a name, which
is not an URL. The pipeline must end with a byte producer, and start with an 
XML consumer.</p>

<p>The sitemap may also contain <code>&lt;delete&gt;</code> entries, which are
used to delete the target.</p>

<p>The sitemap may also contain <code>&lt;property&gt;</code> entries, which are
used to define sitemap wide parameters.</p>


<h3>URLs</h3>

<p>In the sitemap, URLs are used to point out files and other resources. 
See <a href="http://www.ietf.org/rfc/rfc1738.txt">RFC 1738</a> 
for more information about URLs. There are three kinds of URLs:</p>

<ul>
<li>An <em>absolute</em> URL contains at least one colon (<code>:</code>), and 
have no slash (<code>/</code>) before the first colon. The part before the 
first colon is called the <em>scheme</em>. E.g. 
<code>http://www.foo.com/bar/baz.html</code> 
(the scheme here is <code>html</code>).</li>

<li>An <em>pseudo-absolute</em> URL starts with a slash. 
E.g. <code>/foo/bar.xml</code>. When used as source, it is searched for
relative to the local source root directory.</li> 

<li>A <em>relative</em> URL meets non of these two criteria. E.g. 
<code>pic/photo.jpeg</code></li>.
</ul>

<p>Absolute URLs are handled by the <code>java.net.URLConnection</code>
class in Java. It has a pluggable API and it's possible to install custom 
handlers for any scheme (see the Java documentation for information about 
this). At least <code>http</code>, <code>https</code> and <code>ftp</code> are included in Java2 1.4.
However, three schemes are handled specially by Lagoon: 
<code>file</code>, <code>res</code> and <code>part</code>.</p>

<p>The <code>file</code> scheme is used to point out a file anywhere in the 
local file system. Lagoon handles this by itself because the support for it
in several versions of Java is broken. These URLs must be written in the form
<code>file:<em>native absolute file path</em></code>. E.g. 
<code>file:/usr/local/file.txt</code> on a UNIX system or 
<code>file:C:\Documents\file.txt</code> on a Windows or OS/2 system. 
(Note that this is <em>not</em> according to the definition of 
<code>file</code> URLs in RFC 1738.)</p>

<p>The <code>res</code> scheme is used to point out resources included in 
the Lagoon distribution. These resources are loaded from the Java <code>CLASSPATH</code>, 
you can add your own resources by adding them to the Java <code>CLASSPATH</code>.
See the <a href="resource.html">Resource Guide</a> for information about 
the included resources. E.g. <code>res:/style/imageindex.xsl</code></p>

<p>The <code>part</code> scheme is used to point out a <code>&lt;part&gt;</code> 
defined in the sitemap. E.g. <code>part:thePart</code>.</p>

<p>Dependency checking of sources works for relative, pesudo-absolute and 
absolute URLs with <code>file</code> or <code>part</code> 
schemes. However, it does <em>not</em> work with absolute URLs with other 
schemes, if any such is used as source, it causes rebuilding each time.
Absolute URLs with <code>res</code> scheme <em>never</em> causes rebuilding.</p>


<h3>Producers</h3>

<p>A file is created with a pipeline of connected <em>producers</em>. A
producer is a component which produces a stream of bytes (implemented
using a Java OutputStream) or a stream of XML data (implemented using
SAX2 events). A producer may additionally take a stream of bytes or XML
data as input (if it does not, it is a <em>source producer</em>). A
pipeline is a chain of connected producers.</p>

<p>Lagoon has defined six types of producers:</p>

<dl>

<dt>Format</dt><dd>which inputs XML data and outputs bytes. Will
typically be used as the last step in the pipeline.</dd>

<dt>Transform</dt><dd>which inputs XML data and outputs XML data. Can
be used to perform XSLT transformations.</dd>

<dt>Source</dt><dd>which is a source producer outputting XML data. Will
typically be an XML parser that reads a source file.</dd>

<dt>Read</dt><dd>which is a source producer outputting bytes. Will
typically be used to copy a source file unchanged (useful for e.g.
images).</dd>

<dt>Parse</dt><dd>which inputs bytes and outputs XML data.</dd>

<dt>Process</dt><dd>which inputs bytes and outputs bytes.</dd>

</dl>

<p>Parameters can be passed to a producer, which is useful for e.g.
giving the name of the stylesheet to a XSLT processor, parameters are given
as attribute to the producer element in the sitemap. Any character content
to the source producer elements is taken as a parameter with the name "name".
Each file entry may have an main source, which can be read by the source 
producer (however, a source producer may instead obtain the data from some 
other source).</p>

<p>When Lagoon is started, the sitemap is parsed and a pipeline is set
up for each file entry. Lagoon is now ready to build the website, which
can be done several times since the pipelines are reusable.</p>

<p>The website building is performed by processing each file entry
in the sitemap. A file entry is only processed if necessary, i.e. if
any source data has been updated since the last time it was
processed. It's up to each producer to implement this dependency
checking.</p>


<h3>Wildcards</h3>

<p>You can specify similar treatment of several files by using a wildcard
in the source filename. Lagoon will enumerate all source files matching
the given wildcard pattern, and process all of them in sequence. The
target filename must also contains a wildcard, it will be instantiated
with the same string used to match the source pattern, i.e. if the
source pattern is <code>*.xml</code> and the target is
<code>*.html</code>, then the source file <code>book.xml</code> will
generate <code>book.html</code>. You cannot use wildcards if the source
is an absolute URL.</p>


<h3>Splitting</h3>

<p>Producer may have a special feature called <em>split</em> which
works as a transform, but can generate several output files from one
single source. The pipeline after a split producer will be executed
once for each part the split producer generates (it has to generate a
filename for it as well).</p>


<h3>Islands</h3>

<p>Producer may have a special feature called <em>island</em> which
works as a transform, but can generate several output files from one
single source. Parts of the source document will be redirected to other 
output pipelines, using <code>&lt;output&gt;</code> entries in the sitemap
(it has to generate a filename for it as well).</p>


<h2>The standard producers</h2>

<p>You can also write your own produceres, see the <a
href="advuserguide.html">Advanced User Guide</a>.</p>

<p>If nothing else is stated, a producer signal the need for rebuilding when
the main source has been updated (for source producers), or asks the
next upstream producer (for other producers).</p>


<h3>&lt;source&gt;</h3>

Parse the main source as XML.


<h3>&lt;source type="dir"&gt;</h3>

<p>The main source must be a directory (and the source URL must end with '/'), 
and may not be an absolute URL with other scheme than <code>file</code> or 
<code>res</code>. The files and subdirectories in this directory 
is listed and provided as XML in the following format:</p>

<pre>
&lt;dirlist&gt;
    &lt;directory filename="somedir" url="/thisdir/somedir" 
        timestamp="987198810097" date="2001-04-13" time="23:53:30"/&gt;
    &lt;file filename="somefile.txt" url="/thisdir/somefile.txt" 
        timestamp="987197358000" date="2001-04-13" time="23:29:18" 
        size="445"/&gt;
&lt;/dirlist&gt;
</pre>

<p>The <code>url</code> attribute contains the same pseudo-absolute URL that
would be used to refer to this file in the sitemap. The <code>timestamp</code> 
attribute contains the number of milliseconds since 1970, as a decimal number.</p>

<p>There is one optional parameter, "pattern", which gives a wildcard
pattern to select which files and subdirectories to include. If
omitted, all files and subdirectories are included.</p>

<p>This producer signals the need for rebuild when the timestamp on the
directory is updated. However, since many operating systems usually
doesn't do that, it will also check if any file is added, removed or
renamed. However, it does <em>not</em> check if the content of any file
in the directory is updated.</p>


<h3>&lt;read&gt;</h3>

<p>Read the main source as a byte stream.</p>


<h3>&lt;transform type="xslt"&gt;</h3>

<p>Applies an XSLT stylesheet to the XML stream.</p>

<p>The mandatory parameter "stylesheet" specifies the location of the
stylesheet, as an URL. If this URL is relative, 
it's searched for relative to the source file. Any relative URL 
imported or included from the stylesheet is searched for relative to 
the stylesheet.</p>

<p>Any relative URL refeered to by the <code>document()</code> function
is searched for relative to the source file. <code>part:</code> URL:s may 
be used in the <code>document()</code> function.</p>

<p>This producer will check if the stylesheet, or any file imported or
included from it has been updated, and in that case signal the need for
rebuild and also recompile the stylesheet. This producer will check if
any file referred to using the <code>document()</code> function has
been updated, and in that case signal the need for rebuild. However,
since the <code>document()</code> function can take an expression as
argument, this may not always work properly. To remedy this problem,
there is a parameter "always", if it's set to any non-empty string,
this producer will signal the need for rebuilding (but not recompile
the stylesheet) each time.</p>

<p>Any other parameters are passed as parameters to the stylesheet (to
be used by top-level &lt;xsl:param&gt; elements in XSLT).</p>

<p>Any <code>xsl:output</code> elements in the stylesheet have no
effect. Specify formatting properties with a <code>format</code>
producer instead.</p>


<h3>&lt;transform type="split"&gt;</h3>

<p>Implements the splitting feature.</p>

<p>The XML stream from the upstream producer is scanned for specific
element, and each occurrence of that element generates one output file.
The XML data outside this element is ignored. The main output will be a
empty dummy file (however, it is needed for dependency checking).</p>

<p>This producer takes three mandatory parameters. "namespace" and
"element" specifies the element to split on.</p>

<p>"outputname" specifies how to construct the filename for each part,
it contains a filename template which contains attribute names
surrounded by braces (<code>[]</code>) which are replaced with the
value of that attribute on the split element. To actually include a
literal brace in the filename, use a double brace.</p>

<p>For example, a sitemap fragment like this:</p>
<pre>
&lt;transform type="split" namespace="" element="thepart" outputname="[name].xml"&gt;
</pre>
<p>with an input fragment like this:</p>
<pre>
&lt;thepart name="first"&gt;
</pre>
<p>will result in the file <code>first.xml</code> being created.</p>

<p>The output name must be a relative URL, and is relative to the main
target file. It must <em>not</em> be pseudo-absolute.</p>

<h3>&lt;transform type="island"&gt;</h3>

<p>Implements the island feature.</p>

<p>The XML stream from the upstream producer is scanned for elements
with specific XML namespaces, and each occurrence of such element generates 
one output file. The XML data outside those elements is passed through 
unchanged. This is typically used to processed embeeded SVG or MathML in 
XHTML documents.</p>

<p>For each XML namespace you want to extract, you need to specify
the three parameters "namespace<em>n</em>", "output<em>n</em>" and 
"outputExt<em>n</em>" where <em>n</em> is a number starting from 0.
"output" specifies which <code>&lt;output&gt;</code> entry in sitemap to 
use for this namespace. "outputExt" specifies the file extension to give
to the generated file (including '.').</p>

<p>Filenames for the extraced parts will be the name of the main file +
 "_image" + a number + the extension given.</p>


<h3>&lt;transform type="lssi"&gt;</h3>

<p>Performs <a href="lssi.html">LSSI</a> processing.</p>

<p>Any relative URL included from the LSSI page is searched 
for relative to the source file.</p>

<p><code>part:</code> URL:s may be used when including. 
Included parts need not to be well-formed.</p> 

<p>This producer will check all files (and other resources) the LSSI
page depends on, and signal the need for rebuilding if any of them are
updated (or always signal the need for rebuilding if any resource
cannot be checked, e.g. an absolute URL).</p>

<h3>&lt;transform type="lsp"&gt;</h3>

<p>Executes an <a href="lspuser.html">LSP</a> page.</p>

<p>Any parameters to this producers are used as parameters to the LSP
page.</p>

<p>Any relative URL imported or included from the LSP page is searched 
for relative to the source file.</p>

<p><code>part:</code> URL:s may be used when including and importing. 
Imported parts must be well-formed (i.e. have a single root element), 
which is not nessesary the case if it's generated by LSP or XSLT. Included parts
need not to be well-formed.</p> 

<p>This producer will check all files (and other resources) the LSP
page depends on, and signal the need for rebuilding if any of them are
updated (or always signal the need for rebuilding if any resource
cannot be checked, e.g. an absolute URL).</p>

<p>This producer can <strong>not</strong> be used together with wildcards.</p>


<h3>&lt;format type="xml"&gt;</h3>

<p>Formats into well-formed XML.</p>

<p>An "encoding" parameter can be used to specify the character
encoding to use, default is UTF-8.</p>

<p>An "indent" parameter can be used to specify the amount of indenting
to use for pretty-printing the result. Default is no indenting.</p>

<p>The "doctype-public" and "doctype-system" parameters can be used to
specify a specific DTD to use. Default is to not use any DTD.</p>


<h3>&lt;format type="html"&gt;</h3>

<p>Formats into classical HTML 4.01.</p>

<p>An "encoding" parameter can be used to specify the character
encoding to use, default is iso-8859-1.</p>

<p>An "indent" parameter can be used to specify the amount of indenting
to use for pretty-printing the result. Default is no indenting.</p>

<p>An "html" parameter can be used to specify which HTML DTD to use, it
can take the values "transitional", "strict" or "frameset".
Default is "transitional".</p>

<p>The "doctype-public" and "doctype-system" parameters can be used to
specify a specific DTD to use. If specified, they will override the
setting of the "html" parameter.</p>


<h3>&lt;format type="xhtml"&gt;</h3>

<p>Formats into XHTML (well-formed XML which also can be consumed by
most non-XML aware HTML browsers).</p>

<p>An "encoding" parameter can be used to specify the character
encoding to use, default is iso-8859-1.</p>

<p>An "indent" parameter can be used to specify the amount of indenting
to use for pretty-printing the result. Default is no indenting.</p>

<p>An "html" parameter can be used to specify which HTML DTD to use, it
can take the values "transitional", "strict" or "frameset". Default is
"transitional".</p>

<p>The "doctype-public" and "doctype-system" parameters can be used to
specify a specific DTD to use. If specified, they will override the
setting of the "html" parameter.</p>

<h3>&lt;format type="text"&gt;</h3>

<p>Formats into plain text.</p>

<p>An "encoding" parameter can be used to specify the character
encoding to use, default is iso-8859-1.</p>

<h3>&lt;format type="fo"&gt;</h3>

<p>Formats XSL:FO into PDF using Apache FOP.</p>

<h3>&lt;format type="svg"&gt;</h3>

<p>Formats SVG into an bitmap image using Apache Batik.</p>

<p>A mandatory parameter "format" specifies the format of the image, it may be 
"jpeg", "png" or "tiff".</p>

<p>For JPEG images, an additional parameter "quality" may be used to specify the
compression rate, it's a floating point number between 0 and 1 where a larger 
number means better quality but less compression (larger file). The default 
quality is 0.8.</p>

<p>It's currently not possible to have xlinks in SVG.</p>

<h3>&lt;parse&gt;</h3>

<p>Parses the byte stream from the upstream producer as XML.</p>

<p>The use of this producer is <strong>not</strong> recommended. In
most cases you can use a &lt;source&gt; instead. Using this producer
may affect performance, and can in some situations cause deadlocks.</p>


<h2>Common usage patterns</h2>

<p>Copy the content of any file, useful for e.g. images:</p>
<pre>
&lt;file target="/john.jpeg" source="/img/john.jpeg"&gt;
  &lt;read/&gt;
&lt;/file&gt;
</pre>

<p>Same as above:</p>
<pre>
&lt;file target="/john.jpeg" source="/img/john.jpeg"/&gt;
</pre>


<p>Format an HTML page. Note that the source HTML file must be XHTML 
(well-formed XML and all HTML elements in the XHTML namespace):</p>
<pre>
&lt;file target="/index.html"&gt;
  &lt;format type="html"&gt;
    &lt;source/&gt;
  &lt;/format&gt;
&lt;/file&gt;
</pre>

<p>Transform a bunch of XML files with an XSLT stylesheet into HTML:</p>
<pre>
&lt;file target="/books/*.html" source="/books/*.xml"&gt;
  &lt;format type="html"&gt;
    &lt;transform type="xslt" stylesheet="/style/book_html.xsl"&gt;
      &lt;source/&gt;
    &lt;/transform&gt;
  &lt;/format&gt;
&lt;/file&gt;
</pre>

<p>Transform the same XML files with another XSLT stylesheet into PDF:</p>
<pre>
&lt;file target="/books/*.pdf" source="/books/*.xml"&gt;
  &lt;format type="fo"&gt;
    &lt;transform type="xslt" stylesheet="/style/book_print.xsl"&gt;
      &lt;source/&gt;
    &lt;/transform&gt;
  &lt;/format&gt;
&lt;/file&gt;
</pre>

<p>Use XSLT to generate an index over all books:</p>
<pre>
&lt;file target="/books/index.html" source="/books"&gt;
  &lt;format type="html"&gt;
    &lt;transform type="xslt" stylesheet="/books/index.xsl"&gt;
      &lt;source type="dir" pattern="*.xml"/&gt;
    &lt;/transform&gt;
  &lt;/format&gt;
&lt;/file&gt;
</pre>

<p>Generate an HTML page using LSP (the parameter "showpicture" is sent
to the LSP page):</p>
<pre>
&lt;file target="/coolpage.html"&gt;
  &lt;format type="html"&gt;
    &lt;transform type="lsp" showpicture="yes"&gt;
      &lt;source/&gt;
    &lt;/transform&gt;
  &lt;/format&gt;
&lt;/file&gt;
</pre>

<p>Define a partial page to be included by another page:</p>
<pre>
&lt;part name="header" source="/header.lsp"&gt;
  &lt;transform type="lsp" menu="yes"&gt;
    &lt;source/&gt;
  &lt;/transform&gt;
&lt;/part&gt;
</pre>

<p>Render a JPEG image from SVG:</p>
<pre>
&lt;file target="/picture.jpeg" source="/picture.svg"&gt;
  &lt;format type="svg" format="jpeg" quality="0.5"&gt;
    &lt;source/&gt;
  &lt;/format&gt;
&lt;/file&gt;
</pre>

<p>Build PNG images for SVG and MathML islands in XHTML.
(Requires that you have an XSLT stylesheet to transform MatmML to SVG,
no such stylesheet is included in Lagoon. The SVG part works fine though.):</p>
<pre>
&lt;output name="svgOutput"&gt;
  &lt;format type="svg" format="png"/&gt;
&lt;/output&gt;

&lt;output name="mathmlOutput"&gt;
  &lt;format type="svg" format="png"&gt;
    &lt;transform type="xslt" stylesheet="/mathml2svg.xsl"/&gt;
  &lt;/format&gt;
&lt;/output&gt;

&lt;file target="/island.html"&gt;
  &lt;format type="html"&gt;
    &lt;transform type="island" 
        namespace1="http://www.w3.org/2000/svg" 
        output1="svgOutput" outputext1=".png"
        namespace2="http://www.w3.org/1998/Math/MathML" 
        output2="mathmlOutput" outputext2=".png"&gt;
      &lt;source/&gt;
    &lt;/transform&gt;
  &lt;/format&gt;
&lt;/file&gt;
</pre>

<p>Delete an old file:</p>
<pre>
&lt;delete target="/oldstuff/outdated.html"/&gt;
</pre>


<h2>Running Lagoon</h2>

<p>Lagoon is invoked by the application class
<code>nu.staldal.lagoon.LagoonCLI</code>. The syntax is one of:</p>
<pre>
lagoon <em>property_file</em> <em>how_to_run</em>
lagoon <em>sitemap_file</em> <em>how_to_run</em>
</pre>

<p>The <em>property_file</em> and <em>sitemap_file</em> is specified using 
a platform-dependent path (e.g. use '\' as path separator in Windows), 
<em>not</em> as an URL. It may be absolute or relative (to the current 
working directory). If the filename ends with "<code>.xml</code>" or 
"<code>.sitemap</code>", it will be taken as a sitemap file, otherwise 
it will be taken as a property file.</p>

<p>The <em>how_to_run</em> argument specifies what Lagoon should do
after initialization. "build" causes it to perform a normal build
(perform dependency checking and rebuild the necessary files) once and
then exit. "force" causes it perform a force build (override dependency
checking and unconditionally rebuild every file) once and then exit. An
integer <em>n</em> will cause it to perform a normal build every
<em>n</em>th second, forever (until terminated). Leaving this argument
out causes it to go into an interactive mode and wait for you to enter
a command (write something on the keyboard and press [ENTER]), 'b' will
cause normal build, 'f' will cause a force build and 'q' will cause it 
to quit.</p>


<h3>The property file</h3>

<p>The property file specifies the sitemap file, the source directory, 
the target and the password to access the target (if nessesary). 
The file is a standard Java property file, i.e.
a text file with one keyword-value pair on each line, separated by ':';
lines beginning with '#' are ignored.</p>

<p>The sitemap file and source directory are specified using platform-dependent 
paths (e.g. use '\' as path separator in Windows), <em>not</em> as URLs. 
They may be absolute or relative (to the current working directory). Please 
note that the Java property file format requires you to escape '\' with '\\'.</p>

<p>If no property file is used (the sitemap file is specified directly on the 
command line), sourceDir and targetURL will both be set to the current 
directory. <strong>Note:</strong> this requires a careful setup of the sitemap,
since the default behaviour is to use the same path as source and target (which
obviously won't work if sourceDir and targetURL are the same).</p>

<p>Sample property file:</p>
<pre>
# Lagoon properties

sitemapFile: C:\\joe_files\\webbsite\\sitemap.xml
sourceDir: C:\\joe_files\\webbsite\\src
targetURL: ftp://joe@ftp.acme.com/public_html/
password: secret
</pre>


<h3>The target specification</h3>

<p>Lagoon is capable to store generated files in a local directory, or
at a remote server using FTP or SSH. You can also write your own
<em>FileStorage</em> to use some other protocol, see the <a
href="advuserguide.html">Advanced User Guide</a>.</p>

<p>To use a local directory, just specify a platform-dependent path.
The directory will be created if it doesn't exist.</p>

<p>To use FTP, specify an absolute URL in the form
<code>ftp://<em>login</em>@<em>host</em>/<em>path</em>/</code>.
The path is relative to your home directory on the remote machine 
(to start from root, do like <code>ftp://joe@foo.bar.com//abs/path/</code>). 
Note that this will send everything, including your password, 
in clear-text over the network. If security is important, use SSH instead. 
This requires you to specify the password in the property file.</p>

<p>To use SSH, specify an absolute URL in the form
<code>ssh://<em>login</em>@<em>host</em>/<em>path</em>/</code>. The
path is relative to your home directory on the remote machine
(to start from root, do like <code>ssh://joe@foo.bar.com//abs/path/</code>). 
You need to have an public key properly setup before using this (you should 
be able to login without entering any password), do not specify the 
password in the property file. This requires a UNIX style shell with access
to the commmands "mkdir -p", "rm -f" and "cat" on the remote server.</p>


<h3>The working directory</h3>

<p>Lagoon will create a working directory that is used to store cached data 
and dependency information. This directory is named ".lagoon" and is created 
in the user's home directory (as pointed out by the Java system property 
"user.home", you can change this by modify the <code>lagoon</code> script to 
pass "-Duser.home=<em>/some/other/dir</em>" on the java command line).</p>

<p>It's safe to remove the working directory when Lagoon is not running, it will
be recreated next time Lagoon is run. If Lagoon suddenly start giving 
unexpected behavior, removing the working directory might remedy the problem. 
However, removing the working directory may cause unnecessary rebuilds next time 
Lagoon is run, especially if you use a FTP or SSH target.</p>


<h2>Using Lagoon from within Apache Ant</h2>

<p>Lagoon comes with an Ant task. Define the Lagoon Ant task in the Ant
build file like this:</p>
<pre>
&lt;taskdef name="lagoon" classname="nu.staldal.lagoon.LagoonAntTask"&gt;
  &lt;classpath&gt;
    &lt;pathelement location="<em>locationOfLagoonJars</em>/lagoon.jar" /&gt;
    &lt;pathelement location="<em>locationOfLagoonJars</em>/xmlutil.jar" /&gt;
  &lt;/classpath&gt;
&lt;/taskdef&gt;  
</pre>

<p>and use one of the following syntaxes:</p>
<pre>
&lt;lagoon propertyFile="<em>propertyFile</em>"/&gt;
    
&lt;lagoon sitemapFile="<em>sitemapFile</em>"
           sourceDir="<em>sourceDir</em>"
           targetURL="<em>targetURL</em>"
           password="<em>password</em>" /&gt;
</pre>

<p>The <em>password</em> attribute can be omitted if not needed. Use the
optional attribute <code>force</code> to override dependency checking.</p>


<h2>Lagoon GUI</h2>

<p>Lagoon comes with a simple GUI which you can use instead of the command
line tool. The application class is <code>nu.staldal.lagoon.LagoonGUI</code>.
The syntax is:</p>
<pre>
lagoongui [<em>property_file</em>]
</pre>

<p>Alternatively, you can simply execute <code>lagoon.jar</code>
(<code>java -jar lagoon.jar</code>),
but that requires you to install the required libraries (Batik and/or FOP) 
as standard extensions in your JRE.</p>


<h2>Adapting your web site for Lagoon</h2>

<p>To make use of the features of Lagoon, you have to ensure that your
HTML source files are in XHTML format (well-formed XML and all HTML elements 
in the XHTML namespace). You might find the tool <a
href="http://www.w3.org/People/Raggett/tidy/">HTML Tidy</a> useful for
this.</p>

<p>Lagoon comes with a tool which checks an XML file for
well-formedness, and reports any errors. The syntax for this tool
is:</p>

<pre>
xmlcheck [-v] <em>xml_file</em>
</pre>

<p><em>xml_file</em> is the file to check, can be specified with a
platform-dependent path or an URL. Use the <code>-v</code> option to
also check for validity (not nessesary for Lagoon). If the XML file is OK,
nothing will be printed, otherwise error messages will be printed.</p>

<p>To help with the process of adapting an existing website, Lagoon
comes with a tool which creates a sitemap from an existing directory
structure. The syntax for this tool is:</p>

<pre>
buildsitemap <em>source_dir</em> <em>sitemap_file</em>
</pre>

<p>The <em>source_dir</em> directory will be recursively processed, and
all files will be added to the sitemap which is written to the file
<em>sitemap_file</em>. BuildSitemap tries to be a bit clever by
treating files differently based on its extension. However, don't
expect the generated sitemap to work fine directly, you probably have
to do manual adjustments. Making use of LSSI, XSLT transformations and
other features requires modifications of the sitemap.</p>

</body>
</html>
