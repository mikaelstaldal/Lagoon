<?xml version="1.0" encoding="iso-8859-1"?>
<html>
<head>
<title>Lagoon User Guide</title>
<link rel="stylesheet" type="text/css" href="manual.css" />
</head>
<body>
<h1>Lagoon User Guide</h1>

<h2>Overview</h2>

<p>Lagoon is an XML-based framework for web site maintenance.</p>

<p>Lagoon does not require support for any dynamic content technology,
such as Servlets, CGI, ASP, SSI, PHP or JSP, on the web server. It's
therefore very useful for sites on cheep web hotels which gives limited
(or no) access to dynamic content features. However, Lagoon is
useful larger sites too, and can be used together with other
dynamic content technologies.</p>

<p>Lagoon is also useful for building HTML based documentation bundles,
for viewing without a web server.</p>

<h2>Background and philosophy</h2>

<h3>The web server: Static and dynamic content</h3>

<p>The basic functionality of a web server is to send the content of a
regular file stored on disk as the response of a request, this is
called static content. The other alternative is to start a process
that generates the response for each request, this is called dynamic
content. The use of dynamic content can be divided into several
categories as follows.</p>

<dl>
<dt>Pseudo-dynamic</dt><dd>where the requested document is generated by
composing information from several files and/or from a database. The
information in the files and in the database is static, i.e. updated in
a controlled manner and not very frequently. This is called
<em>pseudo-dynamic</em> since the produced document is a function of static
information only. In principle, this use of dynamic content is not
necessary since the updates could have been done in static content. The
main reason for using this approach is easier maintenance and updates.
Technologies such as SSI, ASP, PHP and JSP are used for this.</dd>

<dt>Real-time data</dt><dd>where the generated document depends on some
information that is updated frequently and outside the control of the
web server. Technologies such as CGI and Servlets (sometimes also ASP,
PHP and JSP) are used for this.</dd>

<dt>User interaction</dt><dd>where the generated document depends on
parameters in the request and/or state information from previous
requests. Technologies such as CGI and Servlets (sometimes also ASP,
PHP and JSP) are used for this.</dd>
</dl>

<p>It is also possible to have combinations (such as both real-time data
and user interaction).</p>


<h3>Where Lagoon fits in</h3>

<p>Lagoon produces all your pseudo-dynamic content off-line, and send
the result to the web server as static files. This can give better
performance, since processing doesn't have to be done at each request.
This also gives you convenient pseudo-dynamic content on a web server
without explicit support for it.</p>

<p>Lagoon does <em>not</em> handle user interaction, you have to use
the conventional technologies for this. However, while using ASP, JSP
(or whatever) for the few pages with user interaction, you can still
use Lagoon for the rest of the site.</p>

<p>Lagoon can in some cases be used for real-time data, but this
requires a more complicated setup than usual. See the <a
href="advuserguide.html">Advanced User Guide</a>.</p>

<p>In addition, Lagoon keeps track of all content for your web site,
including static files (HTML, images, etc.) and any files for user
interaction (ASP or JSP pages, CGI scripts, or whatever). Lagoon
automatically detects if any source file is updated and regenerate the
dependent content as necessary (and only when necessary). Lagoon can be
seen as a Make tool for web sites, you have the "source code" on your
computer, Lagoon performs "compilation" as necessary and stores the
"object code" directly on the web server (with FTP or SSH if the web
server is remote). This is especially useful if you have a large web
site and updates it over a slow dial-up modem connection; if you make
changes to only a few pages, only those pages are actually transmitted
to the web server.</p>


<h2>User requirements</h2>

<p>To make use of Lagoon, you need to know XML (including namespaces).
Many usage patterns require knowledge of XSLT too. See <a
href="http://www.w3.org/">http://www.w3.org/</a> for more information
of XML, XSLT and related technologies.</p>

<p>You don't need to know the Java programming language to make use of
the basic features of Lagoon.</p>


<h2>System requirements</h2>

<ul>
<li>A Java Runtime Environment (JRE), version 1.1 or later. Lagoon works
with Java2 too. See <a href="http://java.sun.com/">http://java.sun.com/</a> 
for information on how to obtain a JRE. Note that the Java Development Kit (JDK) 
includes a JRE, you don't need to separately install a JRE if you already
have a JDK.</li>

<li>Apache Xerces (XML Parser) version 1.4.1 or later and Apache Xalan
(XSLT processor) version 2.0 or later. You can download Xerces and Xalan
from <a href="http://xml.apache.org/dist/">http://xml.apache.org/dist/</a>.
The simplest way is to download Xalan only, it includes a suitable version
of Xerces.</li>

<li>To use XSL:FO to PDF formatting, you need Apache FOP (PDF rendering) 
version 0.17 or later. You can download it from 
<a href="http://xml.apache.org/dist/">http://xml.apache.org/dist/</a>.</li>

<li>To use SSH, you need a command-line based SSH client. Most (but
not all) SSH clients for Windows are GUI based, and will not work. A
SSH client will probably work with Lagoon if and only if it works with
CVS.</li>
</ul>


<h2>Installation</h2>

<ol>
<li>Make sure that your JRE is properly installed and working.</li>
<li>Add the distribution JAR files from Xerces, Xalan and (if you use it)FOP (you need both <code>fop.jar</code> and <code>w3c.jar</code>) to your Java
<code>CLASSPATH</code>.</li>
<li>Add all the <code>.jar</code> files in the <code>lib</code> directory
to your Java <code>CLASSPATH</code>.</li>
</ol>

<h2>The core functionality of Lagoon</h2>

<p>Lagoon is based on a <em>sitemap</em>, which is a file describing
the structure of the website. The sitemap is in XML format, see
the <a href="sitemap.dtd">the pseudo-DTD</a> The sitemap has entries
for files, each file entry describes how that file should be
created.</p>

<p>A file is created with a pipeline of connected <em>producers</em>. A
producer is a component which produces a stream of bytes (implemented
using a Java OutputStream) or a stream of XML data (implemented using
SAX events). A producer may additionally take a stream of bytes or XML
data as input (if it does not, it is a <em>source producer</em>). A
pipeline is a chain of connected producers with a byte producer in one
end and a source producer in the other end.</p>

<p>Lagoon has defined six types of producers:</p>

<dl>

<dt>Format</dt><dd>which inputs XML data and outputs bytes. Will
typically be used as the last step in the pipeline.</dd>

<dt>Transform</dt><dd>which inputs XML data and outputs XML data. Can
be used to perform XSLT transformations.</dd>

<dt>Source</dt><dd>which is a source producer outputting XML data. Will
typically be an XML parser that reads a source file.</dd>

<dt>Read</dt><dd>which is a source producer outputting bytes. Will
typically be used to copy a source file unchanged (useful for e.g.
images).</dd>

<dt>Parse</dt><dd>which inputs bytes and outputs XML data.</dd>

<dt>Process</dt><dd>which inputs bytes and outputs bytes.</dd>

</dl>

<p>Parameters can be passed to a producer, which is useful for e.g.
giving the name of the stylesheet to a XSLT processor. Each file entry
may have an input file, which can be read by the source producer
(however, a source producer may instead obtain the data from some other
source).</p>

<p>When Lagoon is started, the sitemap is parsed and a pipeline is set
up for each file entry. Lagoon is now ready to build the website, which
can be done several times since the pipelines are reusable.</p>

<p>The website building is performed by processing each file entry
in the sitemap. A file entry is only processed if necessary, i.e. if
any source data has been updated since the last time it was
processed. It's up to each producer to implement this dependency
checking.</p>

<h3>Wildcards</h3>

You can specify similar treatment of several files by using a wildcard
in the source filename. Lagoon will enumerate all source files matching
the given wildcard pattern, and process all of them in sequence. The
target filename must also contains a wildcard, it will be instantiated
with the same string used to match the source pattern, i.e. if the
source pattern is <code>*.xml</code> and the target is
<code>*.html</code>, then the source file <code>book.xml</code> will
generate <code>book.html</code>.

<h3>Splitting</h3>

<p>Producer may have a special feature called <em>split</em> which
works as a transform, but can generate several output files from one
single source. The pipeline after a split producer will be executed
once for each part the split producer generates (it has to generate a
filename for it as well).</p>


<h2>The standard producers</h2>

<p>You can also write your own produceres, see the <a
href="advuserguide.html">Advanced User Guide</a>.</p>

<p>If nothing else is stated, a producer signal the need for rebuilding when
the source file has been updated (for source producers), or asks the
next upstream producer (for other producers).</p>


<h3>&lt;source&gt;</h3>

Parse the source file as XML.


<h3>&lt;source type="dir"&gt;</h3>

<p>The source must be a directory, and the source URL must end with '/'.
The files and subdirectories in this directory is listed and provided as
XML in the following format:</p>

  <directory filename="CVS" url="/style/CVS" absurl="file:/D:/mikes/lagoon/sample/src/style/CVS"  /> 
  <file filename="first.xsl" url="/style/first.xsl" absurl="file:/D:/mikes/lagoon/sample/src/style/first.xsl" timestamp="987197358000" date="2001-04-13" time="23:29:18" size="445" /> 
  

<pre>
&lt;dirlist&gt;
    &lt;directory filename="somedir" url="/thisdir/somedir" 
        absurl="file:/D:/MySites/ThisSite/thisdir/somedir"
        timestamp="987198810097" date="2001-04-13" time="23:53:30"/&gt;
    &lt;file filename="somefile.txt" url="/thisdir/somefile.txt" 
        absurl="file:/D:/MySites/ThisSite/thisdir/somefile.txt" 
        timestamp="987197358000" date="2001-04-13" time="23:29:18" 
        size="445"/&gt;
&lt;/dirlist&gt;
</pre>

<p>The <code>url</code> attribute contains the same pseudo-absolute URL that
would be used to refer to this file in the sitemap. The <code>timestamp</code> 
attribute contains the number of milliseconds since 1970, as a decimal number.</p>

<p>There is one optional parameter, "pattern", which gives a wildcard
pattern to select which files and subdirectories to include. If
omitted, all files and subdirectories are included.</p>

<p>This producer signals the need for rebuild when the timestamp on the
directory is updated. However, since many operating systems usually
doesn't do that, it will also check if any file is added, removed or
renamed. However, it does <em>not</em> check if the content of any file
in the directory is updated.</p>


<h3>&lt;source type="url"&gt;</h3>

<p>The "name" parameter is parsed as an absolute URL and this URL is fetched
and parsed as XML.</p>

<p>This producer signals the need for rebuild each time, since there is
no way to know whether a general URL has been updated.</p>


<h3>&lt;read&gt;</h3>

<p>Read the source file as a byte stream.</p>


<h3>&lt;read type="url"&gt;</h3>

<p>The "name" parameter is parsed as an absolute URL and this URL is fetched
and provided as a byte stream.</p>

<p>This producer signals the need for rebuild each time, since there is
no way to know whether a general URL has been updated.</p>


<h3>&lt;transform type="xslt"&gt;</h3>

<p>Applies an XSLT stylesheet to the XML stream.</p>

<p>The mandatory parameter "stylesheet" specifies the location of the
stylesheet, as a relative URL. If this URL starts with '/', it relative
to the local source root directory, otherwise it is relative to the
source file. Any relative URL imported or included from the
stylesheet is searched for relative to the stylesheet (or to the
local source root directory if it starts with '/').</p>

<p>Any relative URL refeered to by the <code>document()</code> function
is searched for relative to the source file (or to the local source
root directory if it starts with '/').</p>

<p>This producer will check if the stylesheet, or any file imported or
included from it has been updated, and in that case signal the need for
rebuild and also recompile the stylesheet. This producer will check if
any file referred to using the <code>document()</code> function has
been updated, and in that case signal the need for rebuild. However,
since the <code>document()</code> function can take an expression as
argument, this may not always work properly. To remedy this problem,
there is a parameter "always", if it's set to any non-empty string,
this producer will signal the need for rebuilding (but not recompile
the stylesheet) each time.</p>

<p>Any other parameters are passed as parameters to the stylesheet (to
be used by top-level &lt;xsl:param&gt; elements in XSLT).</p>

<p>Any <code>xsl:output</code> elements in the stylesheet have no
effect. Specify formatting properties with a <code>format</code>
producer instead.</p>


<h3>&lt;transform type="split"&gt;</h3>

<p>Implements the splitting feature.</p>

<p>The XML stream from the upstream producer is scanned for specific
element, and each occurrence of that element generates one output file.
The XML data outside this element is ignored. The main output will be a
empty dummy file (however, it is needed for dependency checking).</p>

<p>This producer takes three mandatory parameters. "namespace" and
"element" specifies the element to split on.</p>

<p>"outputname" specifies how to construct the filename for each part,
it contains a filename template which contains attribute names
surrounded by braces (<code>[]</code>) which are replaced with the
value of that attribute on the split element. To actually include a
literal brace in the filename, use a double brace.</p>

<p>For example, a sitemap fragment like this:</p>
<pre>
&lt;transform type="split" namespace="" element="part" outputname="[name].xml"&gt;
</pre>
<p>with an input fragment like this:</p>
<pre>
&lt;part name="first"&gt;
</pre>
<p>will result in the file <code>first.xml</code> being created.</p>

<p>The output name must be a relative URL, and is relative to the main
target file. It must <em>not</em> start with '/'.</p>

<h3>&lt;transform type="lsp"&gt;</h3>

<p>Executes an LSP page. See the <a href="lspuser.html">LSP User
Guide</a>.</p>

<p>Any parameters to this producers are used as parameters to the LSP
page.</p>

<p>Any relative URL imported from the LSP page is searched for relative
to the source file (or to the local source root directory if it starts
with '/').</p>

<p>Any relative URL included from the LSP page is searched for relative
to the source file (or to the local source root directory if it starts
with '/').</p>

<p>This producer will check all files (and other resources) the LSP
page depends on, and signal the need for rebuilding if any of them are
updated (or always signal the need for rebuilding if any resource
cannot be checked, e.g. an absolute URL).</p>

<p>This producer can <strong>not</strong> be used together with
wildcards.</p>


<h3>&lt;format type="xml"&gt;</h3>

<p>Formats into well-formed XML.</p>

<p>An "encoding" parameter can be used to specify the character
encoding to use, default is UTF-8.</p>

<p>An "indent" parameter can be used to specify the amount of indenting
to use for pretty-printing the result. Default is no indenting.</p>

<p>The "doctype-public" and "doctype-system" parameters can be used to
specify a specific DTD to use. Default is to not use any DTD.</p>


<h3>&lt;format type="html"&gt;</h3>

<p>Formats into classical HTML 4.01.</p>

<p>An "encoding" parameter can be used to specify the character
encoding to use, default is iso-8859-1.</p>

<p>An "indent" parameter can be used to specify the amount of indenting
to use for pretty-printing the result. Default is no indenting.</p>

<p>An "html" parameter can be used to specify which HTML DTD to use, it
can take the values "transitional", "strict" or "frameset".
Default is "transitional".</p>

<p>The "doctype-public" and "doctype-system" parameters can be used to
specify a specific DTD to use. If specified, they will override the
setting of the "html" parameter.</p>


<h3>&lt;format type="xhtml"&gt;</h3>

<p>Formats into XHTML (well-formed XML which also can be consumed by
most non-XML aware HTML browsers).</p>

<p>An "encoding" parameter can be used to specify the character
encoding to use, default is iso-8859-1.</p>

<p>An "indent" parameter can be used to specify the amount of indenting
to use for pretty-printing the result. Default is no indenting.</p>

<p>An "html" parameter can be used to specify which HTML DTD to use, it
can take the values "transitional", "strict" or "frameset". Default is
"transitional".</p>

<p>The "doctype-public" and "doctype-system" parameters can be used to
specify a specific DTD to use. If specified, they will override the
setting of the "html" parameter.</p>

<h3>&lt;format type="text"&gt;</h3>

<p>Formats into plain text.</p>

<p>An "encoding" parameter can be used to specify the character
encoding to use, default is iso-8859-1.</p>

<h3>&lt;format type="fo"&gt;</h3>

<p>Formats XSL:FO into PDF using Apache FOP.</p>


<h3>&lt;parse&gt;</h3>

<p>Parses the byte stream from the upstream producer as XML.</p>

<p>The use of this producer is <strong>not</strong> recommended. In
most cases you can use a &lt;source&gt; instead. Using this producer
may affect performance, and can in some situations cause deadlocks.</p>


<h2>Common usage patterns</h2>

<p>Copy the content of any file, useful for e.g. images:</p>
<pre>
&lt;file target="/john.jpeg" source="/img/john.jpeg"&gt;
  &lt;read/&gt;
&lt;/file&gt;
</pre>

<p>Format an HTML page. Note that the source HTML file must be well-formed
XML (but not necessary valid XHTML):</p>
<pre>
&lt;file target="/index.html" source="/index.html"&gt;
  &lt;format type="html"&gt;
    &lt;source/&gt;
  &lt;/format&gt;
&lt;/file&gt;
</pre>

<p>Transform a bunch of XML files with an XSLT stylesheet into HTML:</p>
<pre>
&lt;file target="/books/*.html" source="/books/*.xml"&gt;
  &lt;format type="html"&gt;
    &lt;transform type="xslt" stylesheet="/style/book_html.xsl"&gt;
      &lt;source/&gt;
    &lt;/transform&gt;
  &lt;/format&gt;
&lt;/file&gt;
</pre>

<p>Transform the same XML files with another XSLT stylesheet into PDF:</p>
<pre>
&lt;file target="/books/*.pdf" source="/books/*.xml"&gt;
  &lt;format type="fo"&gt;
    &lt;transform type="xslt" stylesheet="/style/book_print.xsl"&gt;
      &lt;source/&gt;
    &lt;/transform&gt;
  &lt;/format&gt;
&lt;/file&gt;
</pre>

<p>Use XSLT to generate an index over all books:</p>
<pre>
&lt;file target="/books/index.html" source="/books"&gt;
  &lt;format type="html"&gt;
    &lt;transform type="xslt" stylesheet="/books/index.xsl"&gt;
      &lt;source type="dir" pattern="*.xml"/&gt;
    &lt;/transform&gt;
  &lt;/format&gt;
&lt;/file&gt;
</pre>

<p>Generate an HTML page using LSP (the parameter "showpicture" is sent
to the LSP page):</p>
<pre>
&lt;file target="/coolpage.html" source="/coolpage.html"&gt;
  &lt;format type="html"&gt;
    &lt;transform type="lsp" showpicture="yes"&gt;
      &lt;source/&gt;
    &lt;/transform&gt;
  &lt;/format&gt;
&lt;/file&gt;
</pre>


<h2>Running Lagoon</h2>

<p>Lagoon is invoked by the application class
<code>nu.staldal.lagoon.LagoonCLI</code>. The syntax is:</p>
<pre>
<em>java</em> nu.staldal.lagoon.LagoonCLI <em>property_file</em> <em>how_to_run</em>
</pre>

<p><em>java</em> is your Java interpreter, usually just "java". It's
not recommended to use "javaw" in Sun JDK for Windows, since Lagoon
will write error messages and other information to standard out.</p>

<p>The <em>property_file</em> is specified using a platform-dependent
path (e.g. use '\' as path separator in Windows). It may be absolute or
relative (to the current working directory).</p>

<p>The <em>how_to_run</em> argument specifies what Lagoon should do
after initialization. "build" causes it to perform a normal build
(perform dependency checking and rebuild the necessary files) once and
then exit. "force" causes it perform a force build (override dependency
checking and unconditionally rebuild every file) once and then exit. An
integer <em>n</em> will cause it to perform a normal build every
<em>n</em>th second, forever (until terminated). Leaving this argument
out causes it to go into an interactive mode and wait for you to enter
a command (write something on the keyboard and press [ENTER]), 'b' will
cause normal build, 'f' will cause a force build and just pressing
[ENTER] will cause it to exit.</p>


<h3>The property file</h3>

<p>The property file specifies the sitemap file, the source directory,
the repository directory, the target and the password to access the
target (if nessesary). The file is a standard Java property file, i.e.
a text file with one keyword-value pair on each line, separated by ':';
lines beginning with '#' are ignored.</p>

<p>The sitemap file, source directory and repository directory are
specified using platform-dependent paths (e.g. use '\' as path
separator in Windows). They may be absolute or relative (to the current
working directory).</p>

<p>Sample property file:</p>
<pre>
# Lagoon properties

sitemapFile: C:\joe_files\webbsite\sitemap.xml
sourceDir: C:\joe_files\webbsite\src
repositoryDir: C:\joe_files\webbsite\repository
targetURL: ftp://joe@ftp.acme.com/public_html/
password: secret
</pre>


<h3>The repository</h3>

<p>The repository is used to store cached data and dependency
information. There must be one repository directory for each sitemap.
It's safe to empty the repository when Lagoon is not running, it will
be recreated next time Lagoon is run. However, emptying the repository
may cause unnecessary rebuilds next time Lagoon is run. If Lagoon
suddenly start giving unexpected behavior, emptying the repository
might remedy the problem.</p>


<h3>The target specification</h3>

<p>Lagoon is capable to store generated files in a local directory, or
at a remote server using FTP or SSH. You can also write your own
<em>FileStorage</em> to use some other protocol, see the <a
href="advuserguide.html">Advanced User Guide</a>.</p>

<p>To use a local directory, just specify a platform-dependent path.
The directory will be created if it doesn't exist.</p>

<p>To use FTP, specify an absolute URL in the form
<code>ftp://<em>login</em>@<em>host</em>/<em>path</em>/</code>.
The path is relative to your home directory. Note that this will send
everything, including your password, in clear-text over the network. If
security is important, use SSH instead. This requires you to
specify the password in the property file.</p>

<p>To use SSH, specify an absolute URL in the form
<code>ssh://<em>login</em>@<em>host</em>/<em>path</em>/</code>. The
path is relative to your home directory. You need to have an RSA key
properly setup before using this (you should be able to login without
entering any password), do not specify the password in the property
file.</p>


<h2>Adapting your web site for Lagoon</h2>

<p>To make use of the features of Lagoon, you have to ensure that your
HTML source files are in well-formed XML format (but not necessary
valid XHTML). You might find the tool <a
href="http://www.w3.org/People/Raggett/tidy/">HTML Tidy</a> useful for
this.</p>

<p>Lagoon comes with a tool which checks an XML file for
well-formedness, and reports any errors. The syntax for this tool
is:</p>

<pre>
<em>java</em> nu.staldal.xml.XMLCheck [-v] <em>xml_file</em>
</pre>

<p><em>xml_file</em> is the file to check, can be specified with a
platform-dependent path or an URL. Use the <code>-v</code> option to
also check for validity (not nessesary for Lagoon). If the XML file is OK,
nothing will be printed, otherwise error messages will be printed.</p>

<p>To help with the process of adapting an existing website, Lagoon
comes with a tool which creates a sitemap from an existing directory
structure. The syntax for this tool is:</p>

<pre>
<em>java</em> nu.staldal.lagoon.BuildSitemap <em>source_dir</em> <em>sitemap_file</em>
</pre>

<p>The <em>source_dir</em> directory will be recursively processed, and
all files will be added to the sitemap which is written to the file
<em>sitemap_file</em>. BuildSitemap tries to be a bit clever by
treating files differently based on its extension. However, don't
expect the generated sitemap to work fine directly, you probably have
to do manual adjustments. Making use of LSP, XSLT transformations and
other features requires modifications of the sitemap.</p>

</body>
</html>
